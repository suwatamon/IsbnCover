<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>バーコード認識アプリ</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>

<body>
    Search book's cover from Amazon by ISBN. <br />
    <p>
        Enter ISBN (10 or 13)
        <form action=/reply method=post>
            <input type=text name=isbn value=9784873117522>
            <input type=submit name=submit value=送信>
        </form>
    </p>

    <p>
        Upload ISBN Barcode
        <form action=/barcode method=post enctype="multipart/form-data">
            <input type="file" name="barcode" accept="image/*">
            <input type=submit name=submit_barcode value=Upload>
        </form>
    </p>


    <div id="canvas_area"></div>
    <button id="all_clear">クリア</button>
    <br/>
    <button id="predict">Predict</button>
    <p>予測結果: <span id="result"></span></p>

    <script type="text/javascript">
        (function () {

            const PIXEL_SIZE = 28;
            const CANVAS_FACTOR = 5;
            const canvasWidth = PIXEL_SIZE * CANVAS_FACTOR;
            const canvasHeight = canvasWidth;

            function createCanvas() {
                var mem_canvas;
                mem_canvas = document.createElement("canvas");
                mem_canvas.width = canvasWidth;
                mem_canvas.height = canvasHeight;
                mem_canvas.setAttribute("style", "border: solid");
                var context = mem_canvas.getContext('2d');
                context.fillStyle = "rgb(f,f,f)";
                return mem_canvas;
            }


            var canvasList = [];
            var canvas_area = document.getElementById('canvas_area');

            const N_CANVAS = 2;

            for (var i = 0; i < N_CANVAS; i++) {
                canvasList.push(createCanvas());
                canvas_area.appendChild(canvasList[i]);
            }



            var pixels = [];
            for (var i = 0; i < PIXEL_SIZE ** 2; i++) pixels[i] = 0;

            for (var i = 0; i < N_CANVAS; i++) {
                var canvas = canvasList[i];
                // var drawing = false;

                canvas.addEventListener("mousedown", function (e) {
                    e.target.drawing = true;
                })

                canvas.addEventListener("mouseup", function (e) {
                    e.target.drawing = false;
                })

                canvas.addEventListener("mousemove", function (e) {
                    const CF = CANVAS_FACTOR;
                    const PS = PIXEL_SIZE;
                    if (e.target.drawing) {
                        var x = Math.floor(e.offsetX / CF);
                        var y = Math.floor(e.offsetY / CF);
                        if (0 <= x && x < PS && 0 <= y && y < PS) {
                            e.target.getContext("2d").fillRect(x * CF, y * CF, CF, CF);
                            pixels[x + y * PS] = 1;
                        }
                    }
                })
            }

            $("#predict").click(function () {
                $.ajax({
                    url: "http://localhost:8888/predict",
                    type: "POST",
                    data: {
                        "image1": pixels.join(","),
                        "image2": pixels.join(",")
                    },
                    success: function (result) {
                        document.getElementById("result").innerHTML = result;
                    }
                })
            });

            $("#all_clear").click(function () {
                for (var i = 0; i < N_CANVAS; i++) {
                    var context = canvasList[i].getContext('2d');
                    context.fillStyle = "white";
                    context.fillRect(0, 0, canvasWidth, canvasHeight);
                    context.fillStyle = "black";
                }
            });


        })();
    </script>


</body>

</html>